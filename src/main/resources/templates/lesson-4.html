<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Pelajaran 4: Todo List CRUD</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Lesson Header -->
        <div class="mb-6">
            <div class="flex items-center space-x-3 mb-2">
                <span class="text-4xl">4Ô∏è‚É£</span>
                <h2 class="text-3xl font-bold text-gray-900">Pelajaran 4: Todo List CRUD Operations</h2>
            </div>
            <p class="text-gray-600 text-lg">
                Membangun full CRUD dengan <code class="bg-gray-200 px-2 py-1 rounded text-sm">hx-post</code>,
                <code class="bg-gray-200 px-2 py-1 rounded text-sm">hx-put</code>, dan
                <code class="bg-gray-200 px-2 py-1 rounded text-sm">hx-delete</code>
            </p>
        </div>

        <!-- Lesson Overview -->
        <div class="card bg-indigo-50 border-l-4 border-indigo-500 mb-6">
            <h3 class="text-xl font-bold text-indigo-900 mb-3">üìö Konsep Pelajaran 4</h3>

            <div class="space-y-3 text-sm text-indigo-800">
                <p>
                    <strong>Konsep Baru:</strong> HTMX mendukung semua HTTP methods untuk operasi CRUD lengkap.
                    Kita akan build todo list dengan Create, Read, Update (toggle), dan Delete.
                </p>

                <div class="bg-white rounded p-4 border border-indigo-200 space-y-3">
                    <div>
                        <p class="font-semibold mb-2">üîß HTMX CRUD Operations:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li><code class="bg-indigo-100 px-1 rounded">hx-post="/todos"</code> - Create: Tambah todo baru</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-get="/todos"</code> - Read: Load todo list</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-put="/todos/{id}/toggle"</code> - Update: Toggle complete status</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-delete="/todos/{id}"</code> - Delete: Hapus todo</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">üéØ Targeting & Swapping:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li><code class="bg-indigo-100 px-1 rounded">hx-target="closest li"</code> - Target parent list item</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-swap="outerHTML"</code> - Replace entire element</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-confirm</code> - Konfirmasi sebelum delete</li>
                            <li>Delete return ResponseEntity empty body (element hilang dari DOM)</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">‚ö†Ô∏è Delete Response Pattern:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li><strong>Tidak bisa return empty string</strong> - Spring akan error mencari template dengan nama ""</li>
                            <li><strong>Solusi:</strong> return <code class="bg-indigo-100 px-1 rounded">ResponseEntity.ok().build()</code></li>
                            <li>HTTP 200 OK dengan empty body - HTMX otomatis remove element dari DOM</li>
                            <li>Alternatif: return <code class="bg-indigo-100 px-1 rounded">null</code> untuk skip template rendering</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">üíæ In-Memory Storage:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li>TodoService dengan ConcurrentHashMap</li>
                            <li>Data tersimpan selama aplikasi running</li>
                            <li>Pelajaran 8 nanti migrate ke database</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-white rounded p-3 border border-indigo-200">
                    <p class="font-semibold mb-2">üìÇ Lihat di source code:</p>
                    <ul class="space-y-1 ml-4 text-xs font-mono">
                        <li>üëâ <strong>Model:</strong> model/Todo.java</li>
                        <li>üëâ <strong>Service:</strong> service/TodoService.java</li>
                        <li>üëâ <strong>Controller:</strong> controller/TodoController.java</li>
                        <li>üëâ <strong>List Fragment:</strong> templates/fragments/todo-list.html</li>
                        <li>üëâ <strong>Item Fragment:</strong> templates/fragments/todo-item.html</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Interactive Demo -->
        <div class="card bg-white border-2 border-indigo-200 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                üéÆ Demo Interaktif: Todo List Widget
            </h3>

            <div class="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-300">
                <p class="text-sm text-yellow-900">
                    <strong>üí° Coba Eksperimen:</strong>
                </p>
                <ul class="mt-2 ml-5 text-sm text-yellow-800 space-y-1 list-disc text-left">
                    <li>Tambah beberapa todo - lihat form submit tanpa reload</li>
                    <li>Klik checkbox untuk toggle complete - lihat strikethrough dan warna berubah</li>
                    <li>Klik ‚ùå untuk hapus - lihat konfirmasi dan fade out animation</li>
                    <li>Lihat counter total dan completed otomatis update</li>
                    <li>Perhatikan: tidak ada full page reload sama sekali!</li>
                </ul>
            </div>

            <!-- Todo Widget -->
            <div
                hx-get="/todos"
                hx-trigger="load"
                hx-target="#todo-widget-container">
                <div id="todo-widget-container" class="min-h-[300px] border-2 border-dashed border-indigo-300 rounded-lg p-6 flex items-center justify-center text-indigo-400">
                    <div class="text-center">
                        <div class="animate-spin text-2xl mb-2">‚è≥</div>
                        <p class="text-sm">Loading todos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Explanation -->
        <div class="card bg-gray-50 border-l-4 border-gray-400 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">
                üìù Penjelasan Kode
            </h3>

            <div class="space-y-4">
                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">1. Todo Model (POJO):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>public class Todo {
    private Long id;
    private String title;
    private boolean completed;
    private LocalDateTime createdAt;
    // getters, setters...
}</code></pre>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">2. TodoService (In-Memory Storage):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>@Service
public class TodoService {
    private final Map&lt;Long, Todo&gt; todos = new ConcurrentHashMap&lt;&gt;();
    private final AtomicLong idGenerator = new AtomicLong(1);

    public Todo create(String title) {
        Long id = idGenerator.getAndIncrement();
        Todo todo = new Todo(id, title);
        todos.put(id, todo);
        return todo;
    }

    public void delete(Long id) {
        todos.remove(id);
    }
}</code></pre>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">3. TodoController (CRUD Endpoints):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>@PostMapping
public String create(@RequestParam String title, Model model) {
    todoService.create(title.trim());
    model.addAttribute("todos", todoService.findAll());
    return "fragments/todo-list";
}

@PutMapping("/{id}/toggle")
public String toggle(@PathVariable Long id, Model model) {
    Todo todo = todoService.toggleComplete(id);
    model.addAttribute("todo", todo);
    return "fragments/todo-item";  // Return single item
}

@DeleteMapping("/{id}")
public ResponseEntity&lt;Void&gt; delete(@PathVariable Long id) {
    todoService.delete(id);
    return ResponseEntity.ok().build();  // HTTP 200 OK, empty body
    // HTMX akan remove element dari DOM
}</code></pre>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">4. Todo Item Fragment (Checkbox + Delete):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>&lt;li th:id="'todo-' + ${todo.id}"&gt;
    &lt;!-- Toggle checkbox --&gt;
    &lt;button
        th:hx-put="'/todos/' + ${todo.id} + '/toggle'"
        hx-target="closest li"
        hx-swap="outerHTML"&gt;
        &lt;svg th:if="${todo.completed}"&gt;‚úì&lt;/svg&gt;
    &lt;/button&gt;

    &lt;!-- Title with strikethrough if completed --&gt;
    &lt;span th:classappend="${todo.completed} ? 'line-through' : ''"
          th:text="${todo.title}"&gt;&lt;/span&gt;

    &lt;!-- Delete button --&gt;
    &lt;button
        th:hx-delete="'/todos/' + ${todo.id}"
        hx-target="closest li"
        hx-swap="outerHTML"
        hx-confirm="Hapus todo ini?"&gt;
        ‚ùå
    &lt;/button&gt;
&lt;/li&gt;</code></pre>
                </div>
            </div>
        </div>

        <!-- Key Takeaways -->
        <div class="card bg-green-50 border-l-4 border-green-500 mb-6">
            <h3 class="text-lg font-semibold text-green-900 mb-3">‚úÖ Poin Penting Pelajaran 4</h3>
            <ul class="space-y-2 text-sm text-green-800">
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Full CRUD dengan HTMX</strong> - POST untuk create, PUT untuk update, DELETE untuk delete</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Targeting Elements</strong> - "closest li" untuk target parent element</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Partial Updates</strong> - Toggle return single item, tidak perlu refresh list</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Delete Pattern</strong> - Gunakan ResponseEntity karena empty string ("") akan menyebabkan Spring mencari template thymeleaf dengan nama "" dan menimbulkan error</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>ResponseEntity.ok().build()</strong> - HTTP 200 dengan empty body, HTMX remove element dari DOM</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>hx-confirm</strong> - User confirmation sebelum delete</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>In-Memory Storage</strong> - ConcurrentHashMap untuk thread-safe operations</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Fragment Pattern</strong> - todo-item.html reusable untuk create dan update</span>
                </li>
            </ul>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between">
            <a href="/lesson/3"
               class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                ‚Üê Pelajaran 3
            </a>
            <a href="/lesson/5"
               class="px-6 py-3 bg-gray-300 text-gray-500 font-semibold rounded-lg cursor-not-allowed">
                Pelajaran 5 (Coming Soon) ‚Üí
            </a>
        </div>
    </div>
</body>
</html>
