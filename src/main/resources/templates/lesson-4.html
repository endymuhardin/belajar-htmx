<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Pelajaran 4: Todo List CRUD</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Lesson Header -->
        <div class="mb-6">
            <div class="flex items-center space-x-3 mb-2">
                <span class="text-4xl">4Ô∏è‚É£</span>
                <h2 class="text-3xl font-bold text-gray-900">Pelajaran 4: Todo List CRUD Operations</h2>
            </div>
            <p class="text-gray-600 text-lg">
                Membangun full CRUD dengan <code class="bg-gray-200 px-2 py-1 rounded text-sm">hx-post</code>,
                <code class="bg-gray-200 px-2 py-1 rounded text-sm">hx-put</code>, dan
                <code class="bg-gray-200 px-2 py-1 rounded text-sm">hx-delete</code>
            </p>
        </div>

        <!-- Lesson Overview -->
        <div class="card bg-indigo-50 border-l-4 border-indigo-500 mb-6">
            <h3 class="text-xl font-bold text-indigo-900 mb-3">üìö Konsep Pelajaran 4</h3>

            <div class="space-y-3 text-sm text-indigo-800">
                <p>
                    <strong>Konsep Baru:</strong> HTMX mendukung semua HTTP methods untuk operasi CRUD lengkap.
                    Kita akan build todo list dengan Create, Read, Update (toggle), dan Delete.
                </p>

                <div class="bg-white rounded p-4 border border-indigo-200 space-y-3">
                    <div>
                        <p class="font-semibold mb-2">üîß HTMX CRUD Operations:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li><code class="bg-indigo-100 px-1 rounded">hx-post="/todos"</code> - Create: Tambah todo baru</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-get="/todos"</code> - Read: Load todo list</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-put="/todos/{id}/toggle"</code> - Update: Toggle complete status</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-delete="/todos/{id}"</code> - Delete: Hapus todo</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">üéØ Targeting & Swapping:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li><code class="bg-indigo-100 px-1 rounded">hx-target="closest li"</code> - Target parent list item</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-swap="outerHTML"</code> - Replace entire element</li>
                            <li><code class="bg-indigo-100 px-1 rounded">hx-confirm</code> - Konfirmasi sebelum delete</li>
                            <li>Delete return ResponseEntity empty body (element hilang dari DOM)</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">‚ö†Ô∏è Delete Response Pattern:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li><strong>Tidak bisa return empty string</strong> - Spring akan error mencari template dengan nama ""</li>
                            <li><strong>Solusi:</strong> return <code class="bg-indigo-100 px-1 rounded">ResponseEntity.ok().build()</code></li>
                            <li>HTTP 200 OK dengan empty body - HTMX otomatis remove element dari DOM</li>
                            <li>Alternatif: return <code class="bg-indigo-100 px-1 rounded">null</code> untuk skip template rendering</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">üíæ Database Persistence:</p>
                        <ul class="space-y-1 ml-5 text-xs list-disc">
                            <li>Todo entity dengan JPA annotations (@Entity, @Id)</li>
                            <li>TodoRepository extends JpaRepository</li>
                            <li>Data tersimpan di H2 database (file-based)</li>
                            <li>Data persist saat restart aplikasi</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-white rounded p-3 border border-indigo-200">
                    <p class="font-semibold mb-2">üìÇ Lihat di source code:</p>
                    <ul class="space-y-1 ml-4 text-xs font-mono">
                        <li>üëâ <strong>Entity:</strong> model/Todo.java (JPA entity)</li>
                        <li>üëâ <strong>Repository:</strong> repository/TodoRepository.java</li>
                        <li>üëâ <strong>Service:</strong> service/TodoService.java</li>
                        <li>üëâ <strong>Controller:</strong> controller/TodoController.java</li>
                        <li>üëâ <strong>List Fragment:</strong> templates/fragments/todo-list.html</li>
                        <li>üëâ <strong>Item Fragment:</strong> templates/fragments/todo-item.html</li>
                        <li>üëâ <strong>Migration:</strong> db/migration/V1__create_todos_table.sql</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Interactive Demo -->
        <div class="card bg-white border-2 border-indigo-200 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                üéÆ Demo Interaktif: Todo List Widget
            </h3>

            <div class="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-300">
                <p class="text-sm text-yellow-900">
                    <strong>üí° Coba Eksperimen:</strong>
                </p>
                <ul class="mt-2 ml-5 text-sm text-yellow-800 space-y-1 list-disc text-left">
                    <li>Tambah beberapa todo - lihat form submit tanpa reload</li>
                    <li>Klik checkbox untuk toggle complete - lihat strikethrough dan warna berubah</li>
                    <li>Klik ‚ùå untuk hapus - lihat konfirmasi dan fade out animation</li>
                    <li>Lihat counter total dan completed otomatis update</li>
                    <li>Perhatikan: tidak ada full page reload sama sekali!</li>
                </ul>
            </div>

            <!-- Todo Widget -->
            <div
                hx-get="/todos"
                hx-trigger="load"
                hx-target="#todo-widget-container">
                <div id="todo-widget-container" class="min-h-[300px] border-2 border-dashed border-indigo-300 rounded-lg p-6 flex items-center justify-center text-indigo-400">
                    <div class="text-center">
                        <div class="animate-spin text-2xl mb-2">‚è≥</div>
                        <p class="text-sm">Loading todos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Explanation -->
        <div class="card bg-gray-50 border-l-4 border-gray-400 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">
                üìù Penjelasan Kode
            </h3>

            <div class="space-y-4">
                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">1. Todo Entity (JPA):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>@Entity
@Table(name = "todos")
public class Todo {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, length = 500)
    private String title;

    @Column(nullable = false)
    private boolean completed;

    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;
    // getters, setters...
}</code></pre>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">2. TodoRepository (JPA):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>@Repository
public interface TodoRepository extends JpaRepository&lt;Todo, Long&gt; {
    List&lt;Todo&gt; findAllByOrderByCreatedAtDesc();
}

// JpaRepository provides: save(), findById(), deleteById(), count()
// We only add custom query method for ordering</code></pre>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">3. TodoService (Database Layer):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>@Service
@Transactional
public class TodoService {
    private final TodoRepository todoRepository;

    public Todo create(String title) {
        Todo todo = new Todo(null, title);
        return todoRepository.save(todo);  // Database INSERT
    }

    public void delete(Long id) {
        todoRepository.deleteById(id);  // Database DELETE
    }
}</code></pre>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">4. TodoController (CRUD Endpoints):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>@PostMapping
public String create(@RequestParam String title, Model model) {
    todoService.create(title.trim());
    model.addAttribute("todos", todoService.findAll());
    return "fragments/todo-list";
}

@PutMapping("/{id}/toggle")
public String toggle(@PathVariable Long id, Model model) {
    Todo todo = todoService.toggleComplete(id);
    model.addAttribute("todo", todo);
    return "fragments/todo-item";  // Return single item
}

@DeleteMapping("/{id}")
public ResponseEntity&lt;Void&gt; delete(@PathVariable Long id) {
    todoService.delete(id);
    return ResponseEntity.ok().build();  // HTTP 200 OK, empty body
    // HTMX akan remove element dari DOM
}</code></pre>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-700 mb-2">5. Todo Item Fragment (Checkbox + Delete):</p>
                    <pre class="bg-gray-800 text-gray-100 p-3 rounded text-xs overflow-x-auto"><code>&lt;li th:id="'todo-' + ${todo.id}"&gt;
    &lt;!-- Toggle checkbox --&gt;
    &lt;button
        th:hx-put="'/todos/' + ${todo.id} + '/toggle'"
        hx-target="closest li"
        hx-swap="outerHTML"&gt;
        &lt;svg th:if="${todo.completed}"&gt;‚úì&lt;/svg&gt;
    &lt;/button&gt;

    &lt;!-- Title with strikethrough if completed --&gt;
    &lt;span th:classappend="${todo.completed} ? 'line-through' : ''"
          th:text="${todo.title}"&gt;&lt;/span&gt;

    &lt;!-- Delete button --&gt;
    &lt;button
        th:hx-delete="'/todos/' + ${todo.id}"
        hx-target="closest li"
        hx-swap="outerHTML"
        hx-confirm="Hapus todo ini?"&gt;
        ‚ùå
    &lt;/button&gt;
&lt;/li&gt;</code></pre>
                </div>
            </div>
        </div>

        <!-- Thymeleaf + HTMX Integration -->
        <div class="card bg-blue-50 border-l-4 border-blue-500 mb-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">
                üîó Integrasi Thymeleaf + HTMX
            </h3>

            <div class="space-y-4 text-sm text-blue-800">
                <p>
                    <strong>Pertanyaan:</strong> Apa maksud <code class="bg-blue-100 px-2 py-1 rounded">th:hx-put</code>,
                    <code class="bg-blue-100 px-2 py-1 rounded">th:hx-delete</code>, dll?
                </p>

                <div class="bg-white rounded p-4 border border-blue-200 space-y-3">
                    <div>
                        <p class="font-semibold mb-2">üí° Kenapa Pakai <code>th:</code> Prefix?</p>
                        <p class="text-xs">
                            Thymeleaf prefix <code class="bg-blue-100 px-1 rounded">th:</code> digunakan untuk
                            <strong>generate dynamic values</strong> di server-side sebelum HTML dikirim ke browser.
                        </p>
                        <ul class="mt-2 space-y-1 ml-5 text-xs list-disc">
                            <li><strong>Static HTMX:</strong> <code class="bg-blue-100 px-1 rounded">hx-get="/todos"</code> - URL hardcoded</li>
                            <li><strong>Dynamic HTMX:</strong> <code class="bg-blue-100 px-1 rounded">th:hx-put="'/todos/' + ${"{"}todo.id{'}'}"</code> - URL generated dari data</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">üîÑ Flow: Server ‚Üí Browser</p>
                        <ol class="space-y-2 ml-5 text-xs list-decimal">
                            <li>
                                <strong>Di Server (Thymeleaf Process):</strong>
                                <pre class="bg-gray-800 text-gray-100 p-2 rounded mt-1 overflow-x-auto"><code>&lt;button th:hx-delete="'/todos/' + ${"{"}todo.id{'}'}"&gt;
    Delete
&lt;/button&gt;

// Thymeleaf evaluate: todo.id = 123
// Hasil:</code></pre>
                            </li>
                            <li>
                                <strong>HTML Dikirim ke Browser:</strong>
                                <pre class="bg-gray-800 text-gray-100 p-2 rounded mt-1 overflow-x-auto"><code>&lt;button hx-delete="/todos/123"&gt;
    Delete
&lt;/button&gt;

// Browser hanya lihat hx-delete, tidak ada th: lagi
// HTMX di browser handle hx-delete="/todos/123"</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">üìã Contoh-Contoh Praktis:</p>
                        <table class="w-full text-xs mt-2 border-collapse">
                            <tr class="border-b border-blue-200 bg-blue-50">
                                <th class="text-left py-2 px-2">Thymeleaf (Server)</th>
                                <th class="text-left py-2 px-2">HTML Result (Browser)</th>
                            </tr>
                            <tr class="border-b border-blue-100 font-mono">
                                <td class="py-2 px-2 text-xs">th:hx-put="'/todos/' + ${"{"}todo.id{'}'} + '/toggle'"</td>
                                <td class="py-2 px-2 text-xs">hx-put="/todos/123/toggle"</td>
                            </tr>
                            <tr class="border-b border-blue-100 font-mono">
                                <td class="py-2 px-2 text-xs">th:hx-delete="'/todos/' + ${"{"}todo.id{'}'}"</td>
                                <td class="py-2 px-2 text-xs">hx-delete="/todos/123"</td>
                            </tr>
                            <tr class="border-b border-blue-100 font-mono">
                                <td class="py-2 px-2 text-xs">th:id="'todo-' + ${"{"}todo.id{'}'}"</td>
                                <td class="py-2 px-2 text-xs">id="todo-123"</td>
                            </tr>
                            <tr class="border-b border-blue-100 font-mono">
                                <td class="py-2 px-2 text-xs">th:text="${"{"}todo.title{'}'}"</td>
                                <td class="py-2 px-2 text-xs">Beli susu</td>
                            </tr>
                            <tr class="font-mono">
                                <td class="py-2 px-2 text-xs">th:classappend="${"{"}todo.completed{'}'} ? 'line-through' : ''"</td>
                                <td class="py-2 px-2 text-xs">class="... line-through"</td>
                            </tr>
                        </table>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">‚öôÔ∏è Kapan Pakai <code>th:</code> vs Tidak?</p>
                        <div class="grid grid-cols-2 gap-3 mt-2">
                            <div class="bg-green-50 border border-green-200 rounded p-2">
                                <p class="font-semibold text-green-900 text-xs mb-1">‚úÖ Pakai <code>th:</code></p>
                                <ul class="space-y-1 text-xs list-disc ml-4">
                                    <li>URL dengan ID dari database</li>
                                    <li>Conditional attributes</li>
                                    <li>Dynamic text/values</li>
                                    <li>Loop data dari server</li>
                                </ul>
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded p-2">
                                <p class="font-semibold text-red-900 text-xs mb-1">‚ùå Tidak Perlu <code>th:</code></p>
                                <ul class="space-y-1 text-xs list-disc ml-4">
                                    <li>URL static/hardcoded</li>
                                    <li>hx-target (static selector)</li>
                                    <li>hx-swap (static strategy)</li>
                                    <li>hx-trigger (static event)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-300 rounded p-3">
                        <p class="font-semibold text-yellow-900 text-xs mb-1">üí° Key Insight:</p>
                        <p class="text-xs text-yellow-800">
                            <code class="bg-yellow-100 px-1 rounded">th:</code> adalah <strong>template processing</strong> (terjadi di server sebelum dikirim).
                            Setelah sampai browser, <code>th:</code> sudah hilang dan diganti dengan nilai final.
                            Browser hanya melihat HTMX attributes biasa seperti <code class="bg-yellow-100 px-1 rounded">hx-delete="/todos/123"</code>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- H2 Console -->
        <div class="card bg-white border-2 border-purple-200 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                üñ•Ô∏è H2 Database Console
            </h3>

            <div class="space-y-3">
                <p class="text-sm text-gray-700">
                    H2 menyediakan web-based console untuk browse database secara langsung.
                    Gunakan untuk verify bahwa data benar-benar tersimpan di database.
                </p>

                <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <p class="text-sm font-semibold text-purple-900 mb-2">Cara Akses H2 Console:</p>
                    <ol class="space-y-1 ml-5 text-xs text-purple-800 list-decimal">
                        <li>Pastikan aplikasi running: <code class="bg-purple-100 px-1 rounded">./mvnw spring-boot:run</code></li>
                        <li>Buka browser: <a href="/h2-console" target="_blank" class="text-purple-600 hover:underline font-semibold">http://localhost:8080/h2-console</a></li>
                        <li>Login dengan:
                            <ul class="ml-5 mt-1 space-y-0.5 list-disc">
                                <li><strong>JDBC URL:</strong> <code class="bg-purple-100 px-1 rounded">jdbc:h2:file:./data/belajardb</code></li>
                                <li><strong>User Name:</strong> <code class="bg-purple-100 px-1 rounded">sa</code></li>
                                <li><strong>Password:</strong> (kosong)</li>
                            </ul>
                        </li>
                        <li>Klik "Connect"</li>
                        <li>Run SQL query: <code class="bg-purple-100 px-1 rounded">SELECT * FROM TODOS</code></li>
                    </ol>
                </div>

                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-sm font-semibold text-green-900 mb-2">‚úÖ Testing Database Persistence:</p>
                    <ol class="space-y-1 ml-5 text-xs text-green-800 list-decimal">
                        <li>Tambah beberapa todos di widget demo di atas</li>
                        <li>Buka H2 Console dan run query <code class="bg-green-100 px-1 rounded">SELECT * FROM TODOS</code></li>
                        <li>Verify todos muncul di database dengan ID, title, completed status, created_at</li>
                        <li>Refresh halaman - todos tetap ada (tidak hilang)</li>
                        <li>Restart aplikasi - todos masih tetap ada (data persist!)</li>
                    </ol>
                </div>

                <div class="p-3 bg-yellow-50 rounded border border-yellow-300">
                    <p class="text-xs text-yellow-900">
                        <strong>üí° Tips:</strong> H2 Console berguna untuk debugging. Bisa lihat struktur table,
                        run custom SQL queries, dan verify data integrity. Database file tersimpan di
                        <code class="bg-yellow-100 px-1 rounded">./data/belajardb.mv.db</code>.
                    </p>
                </div>
            </div>
        </div>

        <!-- Key Takeaways -->
        <div class="card bg-green-50 border-l-4 border-green-500 mb-6">
            <h3 class="text-lg font-semibold text-green-900 mb-3">‚úÖ Poin Penting Pelajaran 4</h3>
            <ul class="space-y-2 text-sm text-green-800">
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Full CRUD dengan HTMX</strong> - POST untuk create, PUT untuk update, DELETE untuk delete</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Targeting Elements</strong> - "closest li" untuk target parent element</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Partial Updates</strong> - Toggle return single item, tidak perlu refresh list</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Delete Pattern</strong> - Gunakan ResponseEntity karena empty string ("") akan menyebabkan Spring mencari template thymeleaf dengan nama "" dan menimbulkan error</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>ResponseEntity.ok().build()</strong> - HTTP 200 dengan empty body, HTMX remove element dari DOM</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>hx-confirm</strong> - User confirmation sebelum delete</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Database Persistence</strong> - JPA/Hibernate dengan H2 database untuk data yang persist</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>@Transactional</strong> - Service methods dibungkus dalam transaction untuk data consistency</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Fragment Pattern</strong> - todo-item.html reusable untuk create dan update</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">‚Ä¢</span>
                    <span><strong>Frontend Tidak Berubah</strong> - HTMX tetap sama, hanya backend yang pakai database</span>
                </li>
            </ul>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between">
            <a href="/lesson/3"
               class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                ‚Üê Pelajaran 3
            </a>
            <a href="/lesson/5"
               class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                Pelajaran 5 ‚Üí
            </a>
        </div>
    </div>
</body>
</html>
